# To-Do List (개선 계획 - 우선순위)

## Ⅰ. 최우선 개선 (High Priority)
이 항목들은 애플리케이션의 핵심 기능 안정성, 데이터 무결성, 그리고 기본적인 성능 및 개발 효율성에 직접적인 영향을 미칩니다.

### 0. 불량
1. [전략스케줄러] 전략에서 매수/매도 API를 실패하는 경우가 종종 있음. 1차로 사실 실패하면 log만되고, web에 남는 history는 저장이 안되는게 맞을거같고 2번쨰로는 실패하는경우에는 retry를 해야할거같음. retry 하는 queue를 만들어서 재시도하는 logic 추가가 필요.
2. [전략스케줄러] 전략에서 실행이력이 발생하면 web_veiw가 udpate 되도록 수정.
3. [모의투자결과View] 현재가 조회하는데 오래걸리는걸로 보이는데, 어떻게 할지 고민필요.
6. tr_ids_config.yaml과 kis_config.yaml에 있는 tr_id, url을 (실전,모의) tuple로 바꾸고 모의에서 불가능한건 비워놓고 없으면 못쓰는 방식으로 수정하자.
7. [현재가차트] 장마감 이후 최근날짜 candle 차트가 2개 만들어지는 불량. (by claude)
13. [투자결과] 수수료도 적용하여 수익률 계산
14. [프로그램매매] 구독한 종목 여러개를 선택할 수 있도록 수정. (by claude)
15. [모의투자기록] 특정 전략을 골르면 차트에도 해당 전략에 해당하는 line만 남도록 수정 필요. (by claude)


### 1. 환경 (Environment)
* 
### 2. 성능 (Performance)
* **[개선 필요]** 시장이 닫혔으면 스레드를 통해 전체 종목을 백그라운드로 업데이트하여 RAM에 올려두게 하기.
* **[개선 필요]** **[현재가차트]** 많이 빨라졌지만 아직도 차트가 1초내외로 기다려야 나오는 문제가 있음 우선순위 낮게 수정 필요. OHLCV의 과거데이터는 바뀌질 않으니, 이전 data는 local에 저장해서 가지고 오는게 더 빠르게 처리할 수 있을거같음. 오늘 data와 관련된 candle chart, ma, bb 등만 새로 API 호출해서 계산하면 될거같음.

### 3. 오류 처리 (Error Handling)
* **[강화]** API 응답 검증 강화: `_handle_response` 및 API 응답에서 `output` 데이터의 존재 여부 및 예상 형식에 대한 명시적인 검증 추가.
* **[일관성]** 로그 메시지의 일관성: 모든 중요한 예외 상황에서 `exc_info=True`를 사용하여 스택 트레이스를 일관되게 기록.

### 4. API 상호작용 (API Interaction)
* **[세분화]** 재시도 로직의 세분화: API 응답 코드 또는 오류 유형에 따라 재시도 횟수나 지연 시간을 동적으로 조절하는 백오프(backoff) 전략 구현.

### 5. 테스트 (Tests)
* **[개선 필요]** 코드 커버리지 100% 달성.

## Ⅱ. 중간 우선순위 (Medium Priority)
이 항목들은 코드의 유지보수성, 개발 효율성, 그리고 장기적인 안정성을 개선하는 데 중요합니다. 최우선 개선 사항들이 해결된 후 진행하는 것이 좋습니다.

### 1. 코드 구조 및 모듈성 (Code Structure & Modularity)
* **[명확화]** `BrokerAPIWrapper`의 역할 명확화: 증권사 API 추상화에 집중하고, `KoreaInvestApiClient`는 직접적인 API 호출을 담당하도록 역할 분리.


### 2. 로깅 (Logging)

### 3. 코드 가독성 및 유지보수성 (Code Readability & Maintainability)
* **[강화]** 타입 힌트 강화: 모든 함수 인자 및 반환 값에 타입 힌트를 일관되게 적용하고, `Any` 타입을 구체적인 타입으로 변경.
* **[제거]** 매직 넘버/문자열 제거: 반복적으로 사용되는 상수 값들을 별도의 Enum이나 상수로 정의.
* **[전환]** `print` 문의 로거 전환: 사용자에게 정보를 표시하는 `print` 문을 `logger.info` 또는 `cli_view.display_message`와 같은 로깅/뷰 계층 메서드로 전환.




## Ⅲ. 신규 기능 및 장기 계획 (Lower Priority / New Features & Long-term)
이 항목들은 애플리케이션의 가치를 확장하거나 장기적인 비전을 위한 것으로, 위의 우선순위 항목들이 충분히 안정화된 후에 고려하는 것이 좋습니다.

### 1. 기능 (Features)
* **[신규 기능]** 현재 계좌잔고/관심종목에 포함되에있는 종목들은 APP 시작시 자동으로 프로그램매매실시간동향 구독하도록 하는 기능 추가.
* **[신규 기능]** 시스템에서 발생하는 event를 알려주는 알림창(expand 될수있는)을 우측상단에 추가
* **[신규 기능]** NXT 시장도 포함하도록 개선.
* **[신규 기능]** (주문/계좌) 
* 주식주문(신용) 
* 주식주문(정정취소)<
* 주식정정취소가능주문조회<
* 주식일별주문체결조회
* 매수가능조회<
* 매도가능수량조회< 
* 신용매수가능조회
* 주식예약주문<
* 주식예약주문정정취소<
* 주식예약주문조회<
* 주식잔고조회_실현손익
* 투자계좌자산현황조회
* 기간별손익일별합산조회
* 기간별매매손익현황조회
* 주식통합증거금 
* 기간별계좌권리현황조회 
* **[신규 기능]** 외국인 순매수 상위 종목 조회 기능 추가. (실시간은 없음)
* **[신규 기능]** 종목 추천 기능 추가.(Web에서 AI API를 바로 활용 가능한지?)
* **[신규 기능]** Kis Developers API 문서 크롤링해서 API의 tr_id, url, Header, Params, Body를 최신으로 업데이트 할 수 있는 기능 추가 
* **[신규 기능]** Android App으로 거래결과, 서치 결과 알림 기능 추가. 
* **[신규 기능]** Backtest 기능 추가


### 2. 전략 (Strategy)
* **[탐색 필요]** 다른 전략 탐색 (GPT 추천).
* RVOLBreakout1020 전략 / 백테스트 추가
* ConsolidationScanner 기능 추가.
* **[신규 기능]** 추세 돌파매매(Trend Breakout) - 주가나 자산 가격이 오랫동안 유지되던 저항선을 뚫고 올라가
* [문제] 신규 종목 편입이 안됨, 실제로 좋은 종목이 없는건지 조건이 너무 엄격한건지 확인 필요. (코스닥만 해서 그런가?)
* **[신규 기능]** 오닐식 스퀴즈 주도주 돌파매매 (O'Neil Squeeze Breakout) - "시장의 검증이 끝난 최상위 주도주만 골라내어, 변동성이 극도로 말라붙으며 에너지가 응축된 완벽한 타이밍에만 진입한다."
* v1 구현 범위
- 유니버스: get_top_trading_value_stocks() + 정배열/52주고가/거래대금 필터	구현
- 마켓 타이밍: 시장별 ETF(코스닥→229200, 코스피→069500) 20일 MA 3일 연속 상승	구현
- 스퀴즈: 전일 BB 폭 <= 20일 최소폭 × 1.2	구현
- 가격 돌파 + 거래량 돌파 (환산 150%)	구현
- 프로그램 필터: 순매수>0, 거래대금 대비 10%, 시총 대비 0.5%	구현
- 손절 -5%, 트레일링 -8%, 추세이탈(10MA+대량거래량)	구현
- 시간 손절: 5일 박스권 폭 (최고-최저)/평균종가 < 2%	구현

* v2 예정 (TODO 주석)
- Pool A/B 분리 유니버스 + 동적 편입
    -  풀 A (전일 기준 조건 만족주 - 30종목): * 전일 장 마감 데이터를 기준으로 우리가 설정한 조건(20일선 정배열, 거래대금 100억 이상, 52주 신고가 -20% 이내 등)을 만족하는 종목 중 점수(Scoring)가 가장 높은 코스닥 15종목 + 코스피 중소형주 15종목을 미리 뽑아둡니다.

    목적: 전날 이미 에너지를 응축해 둔(스퀴즈) '오늘 튈 확률이 가장 높은' 녀석들을 장 시작 땡 하자마자 감시하기 위함입니다.

    - 풀 B (당일 실시간 거래대금 깡패 - 30종목):

    장중(예: 09:30, 10:00 등) 증권사 랭킹 API를 호출하여 **'당일 실시간 거래대금 상위 30종목'**을 가져옵니다.

    목적: 전날에는 안 보였지만, 오늘 갑자기 강력한 호재나 테마가 터져서 시장의 돈을 다 블랙홀처럼 빨아들이는 주도주를 중간에 감시망에 편입하기 위함입니다.

- 스코어링 시스템 (RS 상대강도, 업종 소분류, 영업이익 /finance/financial-ratio)
- 체결강도 >= 120%, 고래 탐지 >= 5000만원 (REST inquire-ccnl / WS H0STOUP0)
- 코스닥/코스피 지수 직접 조회

  * **[추가개선] 오닐 스퀴즈 ** 

  2. [전략공통] STATE_FILE 가 제대로 store/load 되고 있는건지 모르겠음. 검증 필요. 만약 장마감시간에 프로그램이 종료되있는 상태라면 이후 복귀했을때 어떻게할지도 정해야함.


  4. [오닐] 매수조건 요구사항을 전달하지 못했는데, _analyze_candidate 에서 RS(상대강도)도 V2로 들어가야 할거 같아. (3개월 상대강도 상위10% +30점). 
  5. [오닐] 4번에 이어서, 스코어링 이 구현되지 않아있어 보임. V2 또는 V3 에서는 스코어링해서 상위점수로 짜르는 기능 추가 필요.


* **[신규 기능]** 포켓 피봇(Pocket Pivot) - 저항선을 뚫기 전, 박스권(베이스) 내부에서 10일선이나 50일선 근처에서 지지받고 고개를 살짝 들 때 매수합니다.



### 3. 테스트 (Tests)
* **[확장 필요]** 통합 테스트의 범위 확장: 실제 API 호출을 포함하는 제한된 통합 테스트 추가 (외부 API 안정성 보장 시).
* **[개선 필요]** Mock 객체의 일관성: 공통 픽스처 활용 또는 Mock 설정 유틸리티를 통해 Mock 객체 설정 중복 제거.
* **[개선 필요]** 현재 존재하는 IT들은 CLI 기반의 IT만 되어있음. CLI 제거하면서 IT가 다 사라졌는데, web_api 기반의 it로 수정 필요.

### 4. 인프라 및 아키텍처 (Infrastructure & Architecture)
* **[인프라]** 도커(Docker) 컨테이너화: `Dockerfile` 및 `docker-compose.yml` 작성을 통해 서버 배포 용이성 확보 및 로컬/서버 환경 불일치(OS 의존성 등) 문제 해결.
* **[데이터]** DB(SQLite/SQLAlchemy) 도입: 매매 일지(Trade Journal) 영구 저장 및 봇 비정상 종료 시 재시작 후 상태 복구(State Recovery) 기능 구현.
* **[안정성]** Pydantic 도입: `config.yaml` 로드 및 API 응답 데이터 처리 시 Pydantic 모델을 사용하여 유효성 검사(Validation) 및 타입 안정성 강화 (런타임 에러 방지).
* **[아키텍처]** 이벤트 기반 아키텍처(Event-Driven): '전략(Signal)'과 '주문 실행(Execution Engine)'의 완전한 분리. 이를 통해 백테스팅 신뢰도를 높이고 향후 복합 주문 처리(Netting) 등의 고도화 기반 마련.
