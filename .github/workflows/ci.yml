name: Python CI

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    # ğŸ” README ìˆ˜ì • ë° Pages ë°°í¬ë¥¼ ìœ„í•´ ëª¨ë“  ì“°ê¸° ê¶Œí•œì„ í™œì„±í™”í•©ë‹ˆë‹¤.
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10" #
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create Mock Config and Data
      run: |
        mkdir -p config data
        cp config/config.yaml.example config/config.yaml || echo "No example config"

    - name: Run tests with coverage
      run: |
        # XML(ë±ƒì§€ìš©)ê³¼ HTML(ì›¹ë°°í¬ìš©) ë¦¬í¬íŠ¸ë¥¼ ëª¨ë‘ ìƒì„±í•©ë‹ˆë‹¤.
        pytest --cov=. --cov-report=xml:coverage.xml --cov-report=html:htmlcov --cov-report=term-missing > coverage.txt

    # ğŸš€ 1. README ë±ƒì§€ ê°•ì œ ì—…ë°ì´íŠ¸ (íŒŒì´ì¬ ì‚¬ìš©)
    - name: Force Update README Badge
      if: github.ref == 'refs/heads/main'
      run: |
        python3 -c "
        import xml.etree.ElementTree as ET
        import re

        # XMLì—ì„œ ìˆ˜ì¹˜ ì¶”ì¶œ
        tree = ET.parse('coverage.xml')
        root = tree.getroot()
        percent = int(float(root.attrib['line-rate']) * 100)
        color = 'green' if percent >= 90 else 'yellow' if percent >= 70 else 'red'
        badge = f'![Coverage](https://img.shields.io/badge/Coverage-{percent}%25-{color})'

        with open('README.md', 'r', encoding='utf-8') as f:
            content = f.read()

        # ì£¼ì„ ì‚¬ì´ ë‚´ìš© êµì²´
        pattern = r'.*?'
        replacement = f'\\n{badge}\\n'
        
        if '' in content:
            new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)
            with open('README.md', 'w', encoding='utf-8') as f:
                f.write(new_content)
            print(f'Successfully updated badge to {percent}%')
        else:
            print('Error: Tags not found in README.md')
        "

        # ë³€ê²½ ì‚¬í•­ ì§ì ‘ í‘¸ì‹œ
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        git add README.md
        git commit -m "chore: update coverage badge [skip ci]" || echo "No changes"
        git push

    # ğŸš€ 2. GitHub Pages ìƒì„¸ ë¦¬í¬íŠ¸ ë°°í¬ (ìœ ì§€)
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: htmlcov/

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4