name: Python CI

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    # ğŸ” README ìˆ˜ì • ë° Pages ë°°í¬ë¥¼ ìœ„í•´ ëª¨ë“  ì“°ê¸° ê¶Œí•œì„ í™œì„±í™”í•©ë‹ˆë‹¤.
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10" #
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create Mock Config and Data
      run: |
        mkdir -p config data
        cp config/config.yaml.example config/config.yaml || echo "No example config"

    - name: Run tests with coverage
      run: |
        # XML(ë±ƒì§€ìš©)ê³¼ HTML(ì›¹ë°°í¬ìš©) ë¦¬í¬íŠ¸ë¥¼ ëª¨ë‘ ìƒì„±í•©ë‹ˆë‹¤.
        pytest --cov=. --cov-report=xml:coverage.xml --cov-report=html:htmlcov --cov-report=term-missing > coverage.txt

    # ğŸš€ 1. README ë±ƒì§€ ê°•ì œ ì—…ë°ì´íŠ¸ (íŒŒì´ì¬ ì‚¬ìš©)
    - name: Force Update README Badge
      if: github.ref == 'refs/heads/main'
      run: |
        python3 -c "
        import xml.etree.ElementTree as ET
        import re

        # 1. ìˆ˜ì¹˜ ì¶”ì¶œ
        try:
            tree = ET.parse('coverage.xml')
            root = tree.getroot()
            percent = int(float(root.attrib['line-rate']) * 100)
            color = 'green' if percent >= 90 else 'yellow' if percent >= 70 else 'red'
            badge = f'![Coverage](https://img.shields.io/badge/Coverage-{percent}%25-{color})'
            
            # 2. README ì½ê¸°
            with open('README.md', 'r', encoding='utf-8') as f:
                content = f.read()

            # 3. ì•ˆì „í•œ êµì²´ ë¡œì§ (ì •ê·œí‘œí˜„ì‹ ì‚¬ìš©)
            begin_tag = ''
            end_tag = ''
            
            if begin_tag in content and end_tag in content:
                # ì²« ë²ˆì§¸ íƒœê·¸ ì„¸íŠ¸ë§Œ ì°¾ì•„ ë±ƒì§€ë¥¼ ë„£ê³ , í˜¹ì‹œ ëª¨ë¥¼ ì¤‘ë³µ íƒœê·¸ëŠ” ëª¨ë‘ ì œê±°í•©ë‹ˆë‹¤.
                pattern = re.escape(begin_tag) + r'.*?' + re.escape(end_tag)
                replacement = f'{begin_tag}\\n{badge}\\n{end_tag}'
                
                # ë¨¼ì € ì²« ë²ˆì§¸ ìœ„ì¹˜ì— ë±ƒì§€ ì‚½ì…
                new_content = re.sub(pattern, replacement, content, count=1, flags=re.DOTALL)
                
                # ê·¸ ë’¤ì— ë‚¨ì•„ìˆëŠ” ì¤‘ë³µ íƒœê·¸ë“¤ì€ ë³¸ë¬¸ ë³´ì¡´ì„ ìœ„í•´ ëª¨ë‘ ì‚­ì œ
                # (ì²« ë²ˆì§¸ replacementì— í¬í•¨ëœ íƒœê·¸ëŠ” ë³´í˜¸ë©ë‹ˆë‹¤)
                final_content = re.sub(pattern, '', new_content, flags=re.DOTALL) if new_content.count(begin_tag) > 1 else new_content

                with open('README.md', 'w', encoding='utf-8') as f:
                    f.write(final_content.strip() + '\\n')
                print(f'Success: Updated to {percent}%')
            else:
                print('Warning: Tags missing in README.md. Skipping update.')
        except Exception as e:
            print(f'Error occurred: {e}')
        "
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        git add README.md
        git commit -m "chore: safe update badge [skip ci]" || echo "No changes"
        git push

    # ğŸš€ 2. GitHub Pages ìƒì„¸ ë¦¬í¬íŠ¸ ë°°í¬ (ìœ ì§€)
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: htmlcov/

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4