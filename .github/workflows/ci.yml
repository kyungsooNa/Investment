name: Python CI

# ì›Œí¬í”Œë¡œìš°ê°€ ì–¸ì œ ì‹¤í–‰ë ì§€ ì •ì˜í•©ë‹ˆë‹¤ (íŠ¸ë¦¬ê±°)
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest  # ìµœì‹  ìš°ë¶„íˆ¬ í™˜ê²½ì—ì„œ ì‹¤í–‰
  
    permissions:
      contents: write  # GitHub Pages ë°°í¬ë¥¼ ìœ„í•´ ì“°ê¸° ê¶Œí•œ í—ˆìš©

    steps:
    # 1. GitHub ë ˆí¬ì§€í† ë¦¬ì˜ ì½”ë“œë¥¼ ê°€ìƒ í™˜ê²½ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. íŒŒì´ì¬ í™˜ê²½ì„ ì„¤ì •í•©ë‹ˆë‹¤. (í˜„ì¬ ì‚¬ìš© ì¤‘ì´ì‹  3.10 ë²„ì „)
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip' # íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì†ë„ë¥¼ ë†’ì´ê¸° ìœ„í•´ pip ìºì‹œ ì ìš©

    # 3. í”„ë¡œì íŠ¸ ì‹¤í–‰ì— í•„ìš”í•œ íŒ¨í‚¤ì§€ë“¤ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # ==========================================
    # [ì—¬ê¸°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”!] 4. í…ŒìŠ¤íŠ¸ìš© ê°€ì§œ ì„¤ì • íŒŒì¼ ë³µì‚¬
    # ==========================================
    - name: Create Mock Config
      run: cp config/config.yaml.example config/config.yaml
    - name: Create data directory
      run: mkdir -p data

    # 5. í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‹¤í–‰
    - name: Run tests with pytest
      run: |
        pytest

    # 6. ì»¤ë²„ë¦¬ì§€(í…ŒìŠ¤íŠ¸ í†µê³¼ìœ¨)ë¥¼ ì¸¡ì •í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    - name: Run tests with coverage
      run: |
        # 1) í„°ë¯¸ë„ ì¶œë ¥(term-missing)ì„ íŒŒì¼ë¡œ ì €ì¥í•˜ê³ , ë™ì‹œì— xmlë„ ë§Œë“­ë‹ˆë‹¤.
        pytest --cov=. --cov-report=term-missing --cov-report=xml --cov-report=html > coverage.txt
        # [ì¤‘ìš”] ì‹¤ì œë¡œ íŒŒì¼ì´ ìƒê²¼ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ ëª©ë¡ì„ ì¶œë ¥í•©ë‹ˆë‹¤.
        echo "Check if htmlcov exists:"
        ls -d htmlcov/ || echo "htmlcov directory NOT FOUND"
        ls -la htmlcov/

    - name: Post Coverage to Summary
      if: always()
      run: |
        echo "## ğŸ“Š ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸" >> $GITHUB_STEP_SUMMARY
        echo "### ìƒì„¸ í˜„í™©" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`text" >> $GITHUB_STEP_SUMMARY
        # í•„ìš”í•œ í‘œ ë¶€ë¶„ë§Œ ê³¨ë¼ë‚´ê±°ë‚˜ ì „ì²´ë¥¼ ë„£ìŠµë‹ˆë‹¤.
        cat coverage.txt >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    # 7. HTML ë¦¬í¬íŠ¸ë¥¼ Artifactë¡œ ì €ì¥ (ë¸Œë¼ìš°ì € í™•ì¸ìš©)
    - name: Upload HTML Coverage Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: python-coverage-report-html  # ë‹¤ìš´ë¡œë“œ ì‹œ íŒŒì¼ ì´ë¦„
        path: htmlcov/                     # pytest-covê°€ ìƒì„±í•˜ëŠ” ê¸°ë³¸ HTML í´ë”ëª…

    # 8. GitHub Pagesì— ë¦¬í¬íŠ¸ ë°°í¬ (ì›¹ì—ì„œ ë°”ë¡œ í™•ì¸ìš©)
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./htmlcov  # âœ… ìƒì„±ëœ ë¦¬í¬íŠ¸ í´ë”
        # destination_dirë¥¼ ì‚­ì œí•˜ì—¬ ì£¼ì†Œë¥¼ ë‹¨ìˆœí™”í•©ë‹ˆë‹¤.
        # ì´ì œ ì£¼ì†ŒëŠ” .../Investment/index.html ì…ë‹ˆë‹¤.
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
    