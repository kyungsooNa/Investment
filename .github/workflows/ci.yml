name: Python CI

# ì›Œí¬í”Œë¡œìš°ê°€ ì–¸ì œ ì‹¤í–‰ë ì§€ ì •ì˜í•©ë‹ˆë‹¤ (íŠ¸ë¦¬ê±°)
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest  # ìµœì‹  ìš°ë¶„íˆ¬ í™˜ê²½ì—ì„œ ì‹¤í–‰
  
    permissions:
      contents: write
      pages: write      # ì¶”ê°€ë¨
      id-token: write   # ì¶”ê°€ë¨

    steps:
    # 1. GitHub ë ˆí¬ì§€í† ë¦¬ì˜ ì½”ë“œë¥¼ ê°€ìƒ í™˜ê²½ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. íŒŒì´ì¬ í™˜ê²½ì„ ì„¤ì •í•©ë‹ˆë‹¤. (í˜„ì¬ ì‚¬ìš© ì¤‘ì´ì‹  3.10 ë²„ì „)
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip' # íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì†ë„ë¥¼ ë†’ì´ê¸° ìœ„í•´ pip ìºì‹œ ì ìš©

    # 3. í”„ë¡œì íŠ¸ ì‹¤í–‰ì— í•„ìš”í•œ íŒ¨í‚¤ì§€ë“¤ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # ==========================================
    # [ì—¬ê¸°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”!] 4. í…ŒìŠ¤íŠ¸ìš© ê°€ì§œ ì„¤ì • íŒŒì¼ ë³µì‚¬
    # ==========================================
    - name: Create Mock Config
      run: cp config/config.yaml.example config/config.yaml
    - name: Create data directory
      run: mkdir -p data

    # 5. í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‹¤í–‰
    - name: Run tests with pytest
      run: |
        pytest

    # 6. ì»¤ë²„ë¦¬ì§€(í…ŒìŠ¤íŠ¸ í†µê³¼ìœ¨)ë¥¼ ì¸¡ì •í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    - name: Run tests with coverage
      run: |
        # 1) í„°ë¯¸ë„ ì¶œë ¥(term-missing)ì„ íŒŒì¼ë¡œ ì €ì¥í•˜ê³ , ë™ì‹œì— xmlë„ ë§Œë“­ë‹ˆë‹¤.
        pytest --cov=. --cov-report=term-missing --cov-report=xml:coverage.xml --cov-report=html:htmlcov > coverage.txt
        # [ì¤‘ìš”] ì‹¤ì œë¡œ íŒŒì¼ì´ ìƒê²¼ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ ëª©ë¡ì„ ì¶œë ¥í•©ë‹ˆë‹¤.
        echo "Check if htmlcov exists:"
        ls -d htmlcov/ || echo "htmlcov directory NOT FOUND"
        ls -la htmlcov/
        ls -l coverage.xml

    - name: Post Coverage to Summary
      if: always()
      run: |
        echo "## ğŸ“Š ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸" >> $GITHUB_STEP_SUMMARY
        echo "### ìƒì„¸ í˜„í™©" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`text" >> $GITHUB_STEP_SUMMARY
        # í•„ìš”í•œ í‘œ ë¶€ë¶„ë§Œ ê³¨ë¼ë‚´ê±°ë‚˜ ì „ì²´ë¥¼ ë„£ìŠµë‹ˆë‹¤.
        cat coverage.txt >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    # 7. HTML ë¦¬í¬íŠ¸ë¥¼ Artifactë¡œ ì €ì¥ (ë¸Œë¼ìš°ì € í™•ì¸ìš©)
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: htmlcov/ # ë¦¬í¬íŠ¸ê°€ ìƒì„±ëœ í´ë” ê²½ë¡œ

    # 8) ë³„ë„ì˜ ë¸Œëœì¹˜ ì—†ì´ GitHub Pages ì„œë²„ì— ì¦‰ì‹œ ë°°í¬í•©ë‹ˆë‹¤.
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    # 1ï¸âƒ£ README ë±ƒì§€ ê°•ì œ ì—…ë°ì´íŠ¸ (ìˆ«ìë§Œ í‘œì‹œ)
    - name: Force Update README Badge
      if: github.ref == 'refs/heads/main'
      run: |
        PERCENT=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); root = tree.getroot(); print(int(float(root.attrib['line-rate'])*100))")
        COLOR=$([ $PERCENT -ge 90 ] && echo "green" || ([ $PERCENT -ge 70 ] && echo "yellow" || echo "red"))
        BADGE="![Coverage](https://img.shields.io/badge/Coverage-$PERCENT%25-$COLOR)"
        sed -i "//,//c\\n$BADGE\n" README.md
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        git add README.md
        git commit -m "chore: update badge to $PERCENT% [skip ci]" || echo "No changes"
        git push

    # 2ï¸âƒ£ ìƒì„¸ ì›¹ ë¦¬í¬íŠ¸ ë°°í¬ (ìƒì„¸ ì°¨íŠ¸ í‘œì‹œ - ì„ íƒ ì‚¬í•­)
    - name: Upload and Deploy Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: htmlcov/
    - name: Deploy to GitHub Pages
      uses: actions/deploy-pages@v4