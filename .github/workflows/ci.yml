name: Python CI

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    # ğŸ” README ìˆ˜ì • ë° Pages ë°°í¬ë¥¼ ìœ„í•´ ëª¨ë“  ì“°ê¸° ê¶Œí•œì„ í™œì„±í™”í•©ë‹ˆë‹¤.
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10" #
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create Mock Config and Data
      run: |
        mkdir -p config data
        cp config/config.yaml.example config/config.yaml || echo "No example config"

    - name: Run tests with coverage
      run: |
        # XML(ë±ƒì§€ìš©)ê³¼ HTML(ì›¹ë°°í¬ìš©) ë¦¬í¬íŠ¸ë¥¼ ëª¨ë‘ ìƒì„±í•©ë‹ˆë‹¤.
        pytest --cov=. --cov-report=xml:coverage.xml --cov-report=html:htmlcov --cov-report=term-missing > coverage.txt

    # ğŸš€ 1. README ë±ƒì§€ ê°•ì œ ì—…ë°ì´íŠ¸ (íŒŒì´ì¬ ì‚¬ìš©)
    - name: Force Update README Badge
      if: github.ref == 'refs/heads/main'
      run: |
        python3 -c "
        import xml.etree.ElementTree as ET
        import re

        # 1. ì»¤ë²„ë¦¬ì§€ ìˆ˜ì¹˜ ê°€ì ¸ì˜¤ê¸°
        try:
            tree = ET.parse('coverage.xml')
            root = tree.getroot()
            percent = int(float(root.attrib['line-rate']) * 100)
            color = 'green' if percent >= 90 else 'yellow' if percent >= 70 else 'red'
            badge = f'![Coverage](https://img.shields.io/badge/Coverage-{percent}%25-{color})'

            # 2. README ì½ê¸°
            with open('README.md', 'r', encoding='utf-8') as f:
                content = f.read()

            # 3. ë³¸ë¬¸ ë³´ì¡´í˜• êµì²´ ë¡œì§
            start_tag = ''
            end_tag = ''

            if start_tag in content and end_tag in content:
                # í‘œì§€íŒ ì‚¬ì´ì˜ ë‚´ìš©ë§Œ íƒ€ê²ŸíŒ…í•˜ëŠ” ì •ê·œí‘œí˜„ì‹
                pattern = re.escape(start_tag) + r'.*?' + re.escape(end_tag)
                new_segment = f'{start_tag}\n{badge}\n{end_tag}'
                
                # íŒŒì¼ ì „ì²´(content)ì—ì„œ í•´ë‹¹ íŒ¨í„´ë§Œ ë”± í•œ ë²ˆ(count=1) êµì²´
                new_content = re.sub(pattern, new_segment, content, count=1, flags=re.DOTALL)

                # [ì¤‘ìš”] ë§Œì•½ ê²°ê³¼ê°€ ë¹„ì–´ìˆì§€ ì•Šì„ ë•Œë§Œ íŒŒì¼ ì“°ê¸°
                if new_content.strip():
                    with open('README.md', 'w', encoding='utf-8') as f:
                        f.write(new_content)
                    print(f'ì„±ê³µ: {percent}% ìˆ˜ì¹˜ë¡œ ì—…ë°ì´íŠ¸ ì™„ë£Œ!')
            else:
                print('ê²½ê³ : READMEì—ì„œ í‘œì§€íŒì„ ì°¾ì§€ ëª»í•´ ìˆ˜ì •ì„ ì·¨ì†Œí•©ë‹ˆë‹¤.')
        except Exception as e:
            print(f'ì—ëŸ¬ ë°œìƒ: {e}')
        "
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        git add README.md
        git commit -m "chore: safe update badge [skip ci]" || echo "No changes"
        git push

    # ğŸš€ 2. GitHub Pages ìƒì„¸ ë¦¬í¬íŠ¸ ë°°í¬ (ìœ ì§€)
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: htmlcov/

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4